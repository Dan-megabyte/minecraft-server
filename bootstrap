#!/bin/bash

set -uo pipefail

umask 077
function die() { echo "[1;31merror:[m $*" >&2; exit 1; }
function status() { echo "[1;33m$*[m"; }
TTY="/dev/$(ps -p $$ -o tty=)"

################################################################
# Ensure that all required tools are installed

abort=0
for i in jq git tmux rdiff-backup java; do
	if ! type "$i" &>/dev/null; then
		echo "[1;31mmissing: [1;33m$i[m" >&2
		abort=1
	fi
done

[[ "$abort" == "0" ]] \
	|| die "Please install the missing tools first."


################################################################
# Ensure EULA is accepted

status "Agree to Mojang EULA"
echo "You have to agree to Mojang's EULA to use the server software."
echo "It is available here: https://account.mojang.com/documents/minecraft_eula"
read -r -p "Do you agree to the EULA? (Y/n) " response < "$TTY" || die "Error in read"
case "${response,,}" in
	''|y|yes) ;;
	*) die "Installation aborted. EULA must be accepted to continue." ;;
esac


################################################################
# Ensure root access

[[ $EUID == 0 ]] || die "Must be root for system-wide installation."


################################################################
# Create minecraft user if necessary

if ! getent passwd minecraft &>/dev/null; then
	status "Creating minecraft user"
	useradd --system --home-dir /var/lib/minecraft --no-create-home minecraft \
		|| die "Could not create user 'minecraft'"
fi

mkdir -p /var/lib/minecraft
chmod 700 /var/lib/minecraft
chown minecraft: /var/lib/minecraft


################################################################
# Setup repository

cd ~minecraft \
	|| die "Could not change into ~minecraft"

if [[ -e deploy ]]; then
	status "Updating deploy repository"
	runuser -u minecraft -- git -C deploy pull \
		|| die "Could not pull repository"
else
	status "Cloning deploy repository"
	runuser -u minecraft -- git clone "https://github.com/oddlama/minecraft-server" deploy \
		|| die "Could not clone repository"
fi

cd deploy \
	|| die "Could not change into deploy directory"

echo "eula=true" > server/eula.txt
chown minecraft: server/eula.txt

runuser -u minecraft -- ./update.sh < "$TTY" \
	|| die "Could not update server files"


################################################################
# Install systemd services

status "Installing service files"
./contrib/install.sh < "$TTY" \
	|| die "Error while installing service files"


################################################################
# Enable and start services

status "Starting services ..."
systemctl enable --now minecraft-server minecraft-proxy < "$TTY" \
	|| die "Error while enabling services"


################################################################
# Appendix

cat <<EOF
===============================================================================
[1;32mInstallation successful![m
Both the proxy and main server have successfully been enabled! The actual
minecraft server will be started, when a player connects via the proxy.

Please make sure that port 25565 (and all multiplexer ports) are exposed to
the internet via a port-foward or similar mechanism. If you want to change
your server configuration, please do so now.

To attach to the proxy or server console, please use the following command:

    minecraft-attach <proxy|server>

This will open the respective tmux (a terminal that is running on your server
in the background for the specific server). [1;31mDo NOT close this terminal![m
It has to stay open in the background at all times, as it is runs the server
instance. Instead, press [32m'C-b d' (Ctrl+b, then d)[m to detach from it.

If you did close it accidentally, please restart the respective server with:

    systemctl restart minecraft-<proxy|server>

For more information, visit https://github.com/oddlama/minecraft-server
-------------------------------------------------------------------------------
EOF
